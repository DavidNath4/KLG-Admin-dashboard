{% extends 'base.html' %}
{% block content %}
<h3 class="mb-3">Daily User Token Usage</h3>
<p class="text-secondary">Token usage dihitung dari messages collection, dikelompokkan per tanggal, user, dan model.</p>

<form method="get" class="mb-3">
  <div class="row gy-2 gx-2 align-items-end">
    <!-- Filter by Agent -->
    <div class="col-12 col-md-4">
      <label class="form-label">Filter by Agent</label>
      <select class="form-select" name="agent" onchange="this.form.submit()">
        <option value="general" {{ 'selected' if selected_agent == 'general' else '' }}>General (all)</option>
        {% for ag in agents_list %}
          <option value="{{ ag.id }}" {{ 'selected' if selected_agent == ag.id else '' }}>{{ ag.name }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- Date From -->
    <div class="col-6 col-md-3">
      <label class="form-label">Date from</label>
      <input type="date" class="form-control" name="date_from" value="{{ date_from or '' }}" max="{{ now_date }}">
    </div>

    <!-- Date To -->
    <div class="col-6 col-md-3">
      <label class="form-label">Date to</label>
      <input type="date" class="form-control" name="date_to" value="{{ date_to or '' }}" max="{{ now_date }}">
    </div>

    <!-- Apply / Clear / Export -->
    <div class="col-12 col-md-2 d-flex gap-2">
      <button class="btn btn-primary btn-sm flex-fill" type="submit">
        <i class="bi bi-check2 me-1"></i>Apply
      </button>
      <a class="btn btn-outline-secondary btn-sm flex-fill" href="{{ url_for('tokens.admin_tokens') }}">
        Clear
      </a>
      <a class="btn btn-success btn-sm flex-fill" href="{{ url_for('tokens.admin_tokens', agent=selected_agent, date_from=date_from, date_to=date_to, export='xlsx') }}">
        Export
      </a>
    </div>
  </div>
</form>

<style>
  .btn-sm {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
  }
</style>

<div class="card">
  <div class="card-header">Results ({{ total }} records)</div>
  <div class="table-responsive">
    <table class="table table-dark table-striped align-middle mb-0">
      <thead>
        <tr>
          <th>#</th>
          <th>Date</th>
          <th>Email</th>
          <th>Model</th>
          <th>Agent</th>
          <th>Total Tokens</th>
          <th>Input Tokens</th>
          <th>Output Tokens</th>
          <th>Total Messages</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
        <tr>
          <td>{{ (page - 1) * per_page + loop.index }}</td>
          <td>{{ r.date }}</td>
          <td>{{ r.email or '-' }}</td>
          <td>{{ r.model_label or '-' }}</td>
          <td>{{ '-' if (r.agent_label == 'General' or not r.agent_label) else r.agent_label }}</td>
          <td>{{ r.total_tokens }}</td>
          <td>{{ r.input_tokens }}</td>
          <td>{{ r.output_tokens }}</td>
          <td>{{ r.total_messages }}</td>
        </tr>
        {% else %}
        <tr>
          <td colspan="9" class="text-center text-secondary py-4">No data.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination Footer -->
  <div class="card-footer d-flex justify-content-between align-items-center">
    <div>
      <form method="get" class="d-inline">
        <input type="hidden" name="agent" value="{{ selected_agent }}">
        <input type="hidden" name="date_from" value="{{ date_from }}">
        <input type="hidden" name="date_to" value="{{ date_to }}">
        <label class="me-2 text-secondary">Per page</label>
        <select name="per_page" class="form-select d-inline w-auto" onchange="this.form.submit()">
          {% for n in [5,10,20,50,100] %}
            <option value="{{ n }}" {% if per_page == n %}selected{% endif %}>{{ n }}</option>
          {% endfor %}
        </select>
      </form>
    </div>
    <nav>
      <ul class="pagination pagination-sm mb-0">
        <li class="page-item {% if page <= 1 %}disabled{% endif %}">
          <a class="page-link"
             href="{{ url_for('tokens.admin_tokens', agent=selected_agent, date_from=date_from, date_to=date_to, page=page-1, per_page=per_page) }}">« Prev</a>
        </li>
        <li class="page-item disabled">
          <span class="page-link">{{ page }}/{{ total_pages }}</span>
        </li>
        <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
          <a class="page-link"
             href="{{ url_for('tokens.admin_tokens', agent=selected_agent, date_from=date_from, date_to=date_to, page=page+1, per_page=per_page) }}">Next »</a>
        </li>
      </ul>
    </nav>
  </div>
</div>
{% endblock %}

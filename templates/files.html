{% extends 'base.html' %}
{% block content %}
<div class="container-fluid py-4 text-light">

  <!-- üßÆ Summary Cards -->
  <div class="row g-3 mb-4">
    <!-- Total Size -->
    <div class="col-12 col-md-4">
      <div class="card bg-dark border-secondary shadow-sm h-100">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <div class="text-secondary small">Total Size (filtered)</div>
            <div class="fs-4 fw-bold text-info">{{ total_size_h }}</div>
            <div class="text-secondary small">{{ "{:,}".format(total_size_bytes) }} bytes</div>
          </div>
          <div class="display-6">üíæ</div>
        </div>
      </div>
    </div>
    <!-- Total Users -->
    <div class="col-12 col-md-4">
      <div class="card bg-dark border-secondary shadow-sm h-100">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <div class="text-secondary small">Total Users (filtered)</div>
            <div class="fs-4 fw-bold text-warning">{{ total_users or 0 }}</div>
            <div class="text-secondary small">Distinct uploader</div>
          </div>
          <div class="display-6">üë•</div>
        </div>
      </div>
    </div>
    <!-- Total Files -->
    <div class="col-12 col-md-4">
      <div class="card bg-dark border-secondary shadow-sm h-100">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <div class="text-secondary small">Total Files (filtered)</div>
            <div class="fs-4 fw-bold text-success">{{ total or 0 }}</div>
            <div class="text-secondary small">All types</div>
          </div>
          <div class="display-6">üóÇÔ∏è</div>
        </div>
      </div>
    </div>
  </div>

  <!-- üîç Filters -->
  <form class="row g-3 align-items-end mb-3" method="get">
    <div class="col-12 col-md-3">
      <label class="form-label">Start Date</label>
      <input type="date" name="start" value="{{ start }}" class="form-control bg-dark text-light border-secondary">
    </div>
    <div class="col-12 col-md-3">
      <label class="form-label">End Date</label>
      <input type="date" name="end" value="{{ end }}" class="form-control bg-dark text-light border-secondary">
    </div>
    <div class="col-12 col-md-3">
      <label class="form-label">User</label>
      <select name="user" class="form-select bg-dark text-light border-secondary">
        <option value="">‚Äî Semua User ‚Äî</option>
        {% for u in user_options %}
          <option value="{{ u._id }}" {{ 'selected' if user == u._id else '' }}>
            {{ u.name }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div class="col-12 col-md-3 d-grid">
      <button class="btn btn-outline-info mt-4" type="submit">
        <i class="bi bi-funnel me-1"></i> Apply Filter
      </button>
    </div>
  </form>

  <!-- ‚¨áÔ∏è Export / Reset -->
  <div class="d-flex gap-2 mb-3">
    <a class="btn btn-outline-success"
       href="{{ url_for('files.file_monitoring', start=start, end=end, user=user, s=s, o=o, export=1) }}">
      <i class="bi bi-file-earmark-excel me-1"></i> Export ke Excel
    </a>
    <a class="btn btn-outline-secondary" href="{{ url_for('files.file_monitoring') }}">Reset</a>
  </div>

  <!-- üìÑ Table -->
  <div class="card bg-dark border-secondary">
    <div class="card-body table-responsive">
      <table class="table table-dark table-hover align-middle">
        <thead>
          <tr>
            <th>#</th>
            {% set new_o = 'asc' if o == 'desc' else 'desc' %}
            <th>
              <a class="link-light text-decoration-none"
                 href="{{ url_for('files.file_monitoring', start=start, end=end, user=user, s='createdAt', o=new_o, page=1, per_page=per_page) }}">
                Created At {% if s == 'createdAt' %}<small class="text-secondary">({{ o }})</small>{% endif %}
              </a>
            </th>
            <th>
              <a class="link-light text-decoration-none"
                 href="{{ url_for('files.file_monitoring', start=start, end=end, user=user, s='filename', o=new_o, page=1, per_page=per_page) }}">
                Filename {% if s == 'filename' %}<small class="text-secondary">({{ o }})</small>{% endif %}
              </a>
            </th>
            <th>
              <a class="link-light text-decoration-none"
                 href="{{ url_for('files.file_monitoring', start=start, end=end, user=user, s='type', o=new_o, page=1, per_page=per_page) }}">
                Type {% if s == 'type' %}<small class="text-secondary">({{ o }})</small>{% endif %}
              </a>
            </th>
            <th class="text-end">
              <a class="link-light text-decoration-none"
                 href="{{ url_for('files.file_monitoring', start=start, end=end, user=user, s='bytes', o=new_o, page=1, per_page=per_page) }}">
                Size {% if s == 'bytes' %}<small class="text-secondary">({{ o }})</small>{% endif %}
              </a>
            </th>
            <th>
              <a class="link-light text-decoration-none"
                 href="{{ url_for('files.file_monitoring', start=start, end=end, user=user, s='user', o=new_o, page=1, per_page=per_page) }}">
                User {% if s == 'user' %}<small class="text-secondary">({{ o }})</small>{% endif %}
              </a>
            </th>
          </tr>
        </thead>
        <tbody>
          {% if rows %}
            {% for r in rows %}
            <tr>
              <td>{{ (page - 1) * per_page + loop.index }}</td>
              <td>{{ r.createdAt.strftime('%Y-%m-%d %H:%M') if r.createdAt else '-' }}</td>
              <td class="fw-semibold">{{ r.filename or '-' }}</td>
              <td><code>{{ r.type or '-' }}</code></td>
              <td class="text-end">{{ r.size_h or '-' }}</td>
              <td>{{ r.user or '-' }}</td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="6" class="text-center text-secondary py-4">Tidak ada data untuk filter ini.</td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    <!-- üìÑ Pagination -->
    <div class="card-footer d-flex justify-content-between align-items-center">
      <div>
        <form method="get" class="d-inline">
          <input type="hidden" name="start" value="{{ start }}">
          <input type="hidden" name="end" value="{{ end }}">
          <input type="hidden" name="user" value="{{ user }}">
          <input type="hidden" name="s" value="{{ s }}">
          <input type="hidden" name="o" value="{{ o }}">
          <label class="me-2 text-secondary">Per page</label>
          <select name="per_page" class="form-select d-inline w-auto" onchange="this.form.submit()">
            {% for n in [10,20,50,100,200] %}
              <option value="{{ n }}" {{ 'selected' if per_page==n else '' }}>{{ n }}</option>
            {% endfor %}
          </select>
        </form>
      </div>
      <nav>
        <ul class="pagination pagination-sm mb-0">
          <li class="page-item {{ 'disabled' if page<=1 }}">
            <a class="page-link bg-dark border-secondary text-light"
               href="{{ url_for('files.file_monitoring', start=start, end=end, user=user, s=s, o=o, page=page-1, per_page=per_page) }}">
               ¬´ Prev</a>
          </li>
          <li class="page-item disabled">
            <span class="page-link bg-dark border-secondary text-light">{{ page }}/{{ total_pages }}</span>
          </li>
          <li class="page-item {{ 'disabled' if page>=total_pages }}">
            <a class="page-link bg-dark border-secondary text-light"
               href="{{ url_for('files.file_monitoring', start=start, end=end, user=user, s=s, o=o, page=page+1, per_page=per_page) }}">
               Next ¬ª</a>
          </li>
        </ul>
      </nav>
    </div>
  </div>

</div>
{% endblock %}
